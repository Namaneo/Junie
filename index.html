<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
</head>

<body>
    <script type="text/javascript" src="/matoya.js"></script>
    <script type="text/javascript" src="/database.js"></script>
    <script type="text/javascript" src="/logging.js"></script>
    <script type="text/javascript" src="/events.js"></script>
    <script type="text/javascript" src="/emulators.js"></script>
    
    <script type="text/javascript">

        function run(system, core, game) {
            //Start core execution
            MTY_Start(`/${core.library}.wasm`, {
                js_get_host:  (value, length) => MTY_StrToC(window.location.hostname, value, length),
                js_get_port:  ()              => window.location.port ?? 0,
                js_is_secure: ()              => location.protocol.indexOf('https') != -1,

                js_get_system: (value, length) => MTY_StrToC(system,    value, length),
                js_get_core:   (value, length) => MTY_StrToC(core.name, value, length),
                js_get_game:   (value, length) => MTY_StrToC(game,      value, length),

                js_read_file:  JUN_ReadFile,
                js_write_file: JUN_WriteFile,
            });

            //Prevent mobile keyboard
            MTY.clip.readOnly = true;
        }

        //Retrieve context parameters
        const params = decodeURI(window.location.pathname).split('/');
        const system = params[1];

        if (system == 'play') {
            var input = document.createElement('input');
            input.type = 'file';
            document.body.appendChild(input);

            input.onchange = e => {
                const file = e.target.files[0];

                const game      = file.name;
                const extension = game.substring(game.lastIndexOf('.') + 1);
                const system    = extensions[extension];
                const core      = systems[system];

                document.body.removeChild(input);

                const _fetch = window.fetch;
                window.fetch = (input, init) => {

                    //Returning the local game file if the request matches
                    if (input.endsWith(`${system}/${game}`)) {
                        const response = new Response(file, { status: 200 });
                        return new Promise(resolve => resolve(response));
                    }

                    return _fetch(input, init);
                }

                run(system, core, game);
            }
        } else {
            const core = systems[system];
            const game = params[2];

            run(system, core, game)
        }
    </script>
</body>

</html>