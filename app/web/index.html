<!doctype html>
<html>

<head>
	<title>Junie</title>

	<meta charset="utf-8">
	<meta name="color-scheme" content="light dark">
	<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<link rel="manifest" href="/manifest.json">
	<link rel="icon" href="/res/favicon.png">
	<link rel="apple-touch-icon" href="/res/icon-apple.png">

	<meta name="theme-color" content="#000000">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>

<body>
	<div id="version" style="text-align: right; margin: 16px; font-family: monospace; font-size: 18px;"></div>
	<img id="loading" src="/res/loading.png" style="position: fixed; inset: 0; width: 100vw; height: 100vh; object-fit: contain; z-index: -1;" />

	<script src="/matoya.js"></script>

	<script>
		const registerServiceWorker = async () => {
			if (!navigator.serviceWorker)
				return;

			try {
				const registration = await navigator.serviceWorker.register('/service-worker.js');

				registration.update();
			} catch (error) {
				console.error(`Registration failed with ${error}`);
			}
		};

		if (location.hostname != 'localhost')
			registerServiceWorker();
	</script>

	<script>
		const junie_build = 'development';

		document.getElementById('version').innerText = junie_build;

		const start = async () => {

			//Override logging functions
			const log = console.log;
			const error = console.error;

			console.log = (data) => data && data != '\n' && log(data);
			console.error = (data) => data && data != '\n' && error(data);

			//Unlock audio context
			const unlock = () => {
				if (MTY.audio?.ctx?.state == 'suspended')
					MTY.audio.ctx.resume();
			};

			window.addEventListener('click', unlock);
			window.addEventListener('touchend', unlock);

			let files = [];
			window.addEventListener('files', (e) => {
				files = e.detail;
				window.frames[0].dispatchEvent(new CustomEvent('files'));
			});

			//Start core execution
			await MTY_Start('junie.wasm', {
				JUN_InteropGetPixelRatio: () => window.devicePixelRatio,
				JUN_InteropGetVersion: () => {
					const cbuild = MTY_Alloc(junie_build.length + 1, 1);
					MTY_StrToC(junie_build, cbuild, junie_build.length + 1);
					return cbuild;
				},
				JUN_InteropReadDir: (cpath, index, file) => {
					const base_path = MTY_StrToJS(cpath);
					const filtered = files.filter(file => file.path.startsWith(base_path));

					if (index >= filtered.length)
						return false;

					const path = filtered[index].path;
					MTY_SetUint32(file, MTY_Alloc(path.length, 1))
					MTY_StrToC(path, MTY_GetUint32(file), path.length + 1);

					return true;
				},
				JUN_InteropReadFile: (cpath, clen) => {
					const path = MTY_StrToJS(cpath);
					const file = files.find(file => file.path == path);

					if (!file) {
						MTY_CFunc(cfunc)(cpath, null, 0, opaque);
						return;
					}

					const result = MTY_Alloc(file.data.length, 1);
					const view = new Uint8Array(mty_mem(), result, file.data.length);
					view.set(file.data);

					if (clen)
						MTY_SetUint32(clen, file.data.length);

					return result;
				},
				JUN_InteropWriteFile: (cpath, cdata, length) => {
					const path = MTY_StrToJS(cpath);

					const buffer = new Uint8Array(length);
					const data = new Uint8Array(mty_mem(), cdata, length);
					buffer.set(data);

					const file = { path: path, data: new Uint8Array(data) };

					window.frames[0].dispatchEvent(new CustomEvent('save', { detail: file }));
				},

				// Exception stubs
				invoke_v: (ptr) => MTY_CFunc(ptr)(),
				invoke_vii: (ptr, x, y) => MTY_CFunc(ptr)(x, y),
				invoke_ii: (ptr, x) => MTY_CFunc(ptr)(x),

				// Emscripten stubs
				_msync_js: () => console.log('_msync_js'),
				_emscripten_throw_longjmp: () => console.log('_emscripten_throw_longjmp'),
				__syscall_stat64: () => console.log('__syscall_stat64'),
				__syscall_newfstatat: () => console.log('__syscall_newfstatat'),
				__syscall_lstat64: () => console.log('__syscall_lstat64'),
				__syscall_ftruncate64: () => console.log('__syscall_ftruncate64'),
				__syscall__newselect: () => console.log('__syscall__newselect'),
				__syscall_bind: () => console.log('__syscall_bind'),
				__syscall_recvfrom: () => console.log('__syscall_recvfrom'),
				__syscall_sendto: () => console.log('__syscall_sendto'),
				__syscall_socket: () => console.log('__syscall_socket'),
			});

			document.getElementById('version').hidden = true;
			document.getElementById('loading').hidden = true;

			//Prevent mobile keyboard
			MTY.clip.readOnly = true;
		}

		start();
	</script>
</body>

</html>
